
package com.example.rehabilitationapp.ui.debug;

import android.graphics.Color;
import android.os.Bundle;
import android.util.Log;
import android.widget.Button;
import android.widget.SeekBar;
import android.widget.Switch;
import android.widget.TextView;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import com.example.rehabilitationapp.R;
import com.example.rehabilitationapp.ui.analysis.CSVPeakAnalyzer;
import com.github.mikephil.charting.charts.LineChart;
import com.github.mikephil.charting.components.XAxis;
import com.github.mikephil.charting.components.YAxis;
import com.github.mikephil.charting.data.Entry;
import com.github.mikephil.charting.data.LineData;
import com.github.mikephil.charting.data.LineDataSet;

import java.util.ArrayList;
import java.util.List;

/**
 * ğŸ”§ DEBUG: å³°å€¼è¦–è¦ºåŒ–é é¢ï¼ˆå¸¶åƒæ•¸èª¿æ•´ï¼‰
 * æ­¤æª”æ¡ˆåƒ…ä¾›é–‹ç™¼éšæ®µèª¿è©¦ä½¿ç”¨ï¼Œæ­£å¼ç‰ˆå¯è€ƒæ…®ç§»é™¤
 */
public class DebugPeakVisualizationActivityBAK extends AppCompatActivity {

    private static final String TAG = "DebugPeakViz";

    // UI å…ƒä»¶
    private LineChart debugPeakChart;
    private TextView debugInfoText;
    private Button debugCloseButton;
    private Button debugRefreshButton;
    private Button debugExportButton;

    // ğŸ›ï¸ åŸæœ¬çš„æ»‘æ¡¿æ§åˆ¶å…ƒä»¶ (ä¿ç•™)
    private SeekBar thresholdMultiplierSlider;
    private SeekBar mergeDistanceSlider;
    private TextView thresholdMultiplierValue;
    private TextView mergeDistanceValue;
    private Switch autoReanalyzeSwitch;

    // ğŸ›ï¸ æ–°å¢ï¼šäº”æª”æ•æ„Ÿåº¦æ§åˆ¶å…ƒä»¶
    private TextView sensitivityLevelText;
    private Button[] sensitivityButtons = new Button[5];
    private int currentSensitivityLevel = 2; // é è¨­ä¸­ç­‰æ•æ„Ÿåº¦

    // æ•¸æ“šè®Šæ•¸
    private String csvFileName;
    private String trainingLabel;
    private int actualCount;
    private int targetCount;

    // ğŸ›ï¸ å¯èª¿æ•´çš„å³°å€¼æª¢æ¸¬åƒæ•¸
    private double thresholdMultiplier = 1.5;  // é–¾å€¼ä¿‚æ•¸ï¼ˆé è¨­ 1.5 å€æ¨™æº–å·®ï¼‰
    private double mergeDistance = 2.0;        // åˆä½µè·é›¢ï¼ˆé è¨­ 2.0 ç§’ï¼‰

    // åŸå§‹æ•¸æ“šï¼ˆä¸æœƒæ”¹è®Šï¼‰
    private List<Double> allDataValues = new ArrayList<>();
    private List<Double> allTimePoints = new ArrayList<>();
    private List<String> allPhases = new ArrayList<>();
    private String targetColumn;
    private double averageValue;
    private double standardDeviation;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.debug_peak_visualization_activity);

        Log.d(TAG, "ğŸ”§ DEBUG: å³°å€¼è¦–è¦ºåŒ–é é¢å•Ÿå‹•ï¼ˆå¸¶æ»‘æ¡¿åŠŸèƒ½+äº”æª”æ•æ„Ÿåº¦ï¼‰");

        // åˆå§‹åŒ– UI
        initViews();

        // å–å¾—å‚³å…¥æ•¸æ“š
        getIntentData();

        // è¨­ç½®æ»‘æ¡¿ç›£è½å™¨ (ä¿ç•™åŸåŠŸèƒ½)
        setupSliders();

        // ğŸ›ï¸ è¨­ç½®æ•æ„Ÿåº¦æŒ‰éˆ•ç›£è½å™¨ (æ–°å¢)
        setupSensitivityButtons();

        // è¨­ç½®æŒ‰éˆ•äº‹ä»¶
        setupButtons();

        // è¼‰å…¥åŸå§‹æ•¸æ“š
        loadOriginalData();
    }

    private void initViews() {
        debugPeakChart = findViewById(R.id.debug_peak_chart);
        debugInfoText = findViewById(R.id.debug_info_text);
        debugCloseButton = findViewById(R.id.debug_close_button);
        debugRefreshButton = findViewById(R.id.debug_refresh_button);
        debugExportButton = findViewById(R.id.debug_export_button);

        // ğŸ›ï¸ åŸæœ¬çš„æ»‘æ¡¿å…ƒä»¶ (ä¿ç•™)
        thresholdMultiplierSlider = findViewById(R.id.threshold_multiplier_slider);
        mergeDistanceSlider = findViewById(R.id.merge_distance_slider);
        thresholdMultiplierValue = findViewById(R.id.threshold_multiplier_value);
        mergeDistanceValue = findViewById(R.id.merge_distance_value);
        autoReanalyzeSwitch = findViewById(R.id.auto_reanalyze_switch);

        // ğŸ›ï¸ äº”æª”æ•æ„Ÿåº¦å…ƒä»¶ (æ–°å¢)
        sensitivityLevelText = findViewById(R.id.sensitivity_level_text);
        sensitivityButtons[0] = findViewById(R.id.sensitivity_level_0);
        sensitivityButtons[1] = findViewById(R.id.sensitivity_level_1);
        sensitivityButtons[2] = findViewById(R.id.sensitivity_level_2);
        sensitivityButtons[3] = findViewById(R.id.sensitivity_level_3);
        sensitivityButtons[4] = findViewById(R.id.sensitivity_level_4);

        // è¨­ç½®åœ–è¡¨åŸºæœ¬æ¨£å¼
        setupChart();

        Log.d(TAG, "ğŸ”§ DEBUG: UI å…ƒä»¶åˆå§‹åŒ–å®Œæˆ");
    }

    private void getIntentData() {
        csvFileName = getIntent().getStringExtra("csv_file_name");
        trainingLabel = getIntent().getStringExtra("training_label");
        actualCount = getIntent().getIntExtra("actual_count", 0);
        targetCount = getIntent().getIntExtra("target_count", 4);

        Log.d(TAG, String.format("ğŸ”§ DEBUG: æ¥æ”¶æ•¸æ“š - CSV: %s, æ¨™ç±¤: %s, å¯¦éš›: %d, ç›®æ¨™: %d",
                csvFileName, trainingLabel, actualCount, targetCount));
    }

    // ğŸ›ï¸ ä¿ç•™åŸæœ¬çš„æ»‘æ¡¿åŠŸèƒ½
    private void setupSliders() {
        // ğŸ›ï¸ é–¾å€¼ä¿‚æ•¸æ»‘æ¡¿ (0.5 - 3.0)
        thresholdMultiplierSlider.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
            @Override
            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
                if (fromUser) {
                    thresholdMultiplier = 0.5 + (progress / 100.0) * 2.5; // 0.5 to 3.0
                    thresholdMultiplierValue.setText(String.format("%.1f", thresholdMultiplier));
                    Log.d(TAG, "ğŸ›ï¸ é–¾å€¼ä¿‚æ•¸èª¿æ•´ç‚º: " + thresholdMultiplier);
                }
            }

            @Override
            public void onStartTrackingTouch(SeekBar seekBar) {}

            @Override
            public void onStopTrackingTouch(SeekBar seekBar) {
                if (autoReanalyzeSwitch.isChecked()) {
                    reanalyzeWithCurrentParams();
                }
            }
        });

        // ğŸ›ï¸ åˆä½µè·é›¢æ»‘æ¡¿ (0.5 - 5.0 ç§’)
        mergeDistanceSlider.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
            @Override
            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
                if (fromUser) {
                    mergeDistance = 0.5 + (progress / 100.0) * 4.5; // 0.5 to 5.0
                    mergeDistanceValue.setText(String.format("%.1f", mergeDistance));
                    Log.d(TAG, "ğŸ›ï¸ åˆä½µè·é›¢èª¿æ•´ç‚º: " + mergeDistance);
                }
            }

            @Override
            public void onStartTrackingTouch(SeekBar seekBar) {}

            @Override
            public void onStopTrackingTouch(SeekBar seekBar) {
                if (autoReanalyzeSwitch.isChecked()) {
                    reanalyzeWithCurrentParams();
                }
            }
        });

        // è¨­ç½®åˆå§‹å€¼
        updateSliderValues();
    }

    // ğŸ›ï¸ æ–°å¢ï¼šäº”æª”æ•æ„Ÿåº¦æŒ‰éˆ•è¨­ç½®
    private void setupSensitivityButtons() {
        String[] levelNames = {"æ¥µä½", "ä½", "ä¸­", "é«˜", "æ¥µé«˜"};

        for (int i = 0; i < 5; i++) {
            final int level = i;
            sensitivityButtons[i].setOnClickListener(v -> {
                currentSensitivityLevel = level;
                updateSensitivityUI();
                updateParametersFromSensitivity(level);

                Log.d(TAG, String.format("ğŸ›ï¸ æ•æ„Ÿåº¦èª¿æ•´ç‚º: %s (ç­‰ç´š %d)", levelNames[level], level));

                if (autoReanalyzeSwitch.isChecked()) {
                    reanalyzeWithCurrentParams();
                }
            });
        }

        // è¨­ç½®åˆå§‹ç‹€æ…‹
        updateSensitivityUI();
    }

    // ğŸ›ï¸ æ–°å¢ï¼šæ•æ„Ÿåº¦è½‰æ›å‡½æ•¸
    private void updateParametersFromSensitivity(int level) {
        switch (level) {
            case 0: // æ¥µä½æ•æ„Ÿåº¦ - åªæŠ“å¾ˆæ˜é¡¯çš„å‹•ä½œ
                thresholdMultiplier = 3.0;
                mergeDistance = 0.5;
                break;
            case 1: // ä½æ•æ„Ÿåº¦ - æŠ“æ˜é¡¯å‹•ä½œ
                thresholdMultiplier = 2.5;
                mergeDistance = 1.0;
                break;
            case 2: // ä¸­æ•æ„Ÿåº¦ - å¹³è¡¡ (é è¨­)
                thresholdMultiplier = 1.5;
                mergeDistance = 2.0;
                break;
            case 3: // é«˜æ•æ„Ÿåº¦ - æŠ“å°å‹•ä½œ
                thresholdMultiplier = 1.0;
                mergeDistance = 3.0;
                break;
            case 4: // æ¥µé«˜æ•æ„Ÿåº¦ - é€£å¾®å°å‹•ä½œéƒ½æŠ“
                thresholdMultiplier = 0.8;
                mergeDistance = 4.0;
                break;
        }

        // ğŸ›ï¸ åŒæ­¥æ›´æ–°æ»‘æ¡¿é¡¯ç¤º
        updateSliderValues();
    }

    // ğŸ›ï¸ æ–°å¢ï¼šæ›´æ–°æ•æ„Ÿåº¦UIé¡¯ç¤º
    private void updateSensitivityUI() {
        String[] levelNames = {"æ¥µä½", "ä½", "ä¸­", "é«˜", "æ¥µé«˜"};
        sensitivityLevelText.setText(levelNames[currentSensitivityLevel]);

        // æ›´æ–°æŒ‰éˆ•é¡è‰²
        for (int i = 0; i < 5; i++) {
            if (i == currentSensitivityLevel) {
                sensitivityButtons[i].setBackgroundColor(Color.parseColor("#FF1976d2"));
                sensitivityButtons[i].setTextColor(Color.WHITE);
            } else {
                sensitivityButtons[i].setBackgroundColor(Color.parseColor("#FFe0e0e0"));
                sensitivityButtons[i].setTextColor(Color.BLACK);
            }
        }
    }

    private void updateSliderValues() {
        int thresholdProgress = (int) ((thresholdMultiplier - 0.5) / 2.5 * 100);
        int mergeProgress = (int) ((mergeDistance - 0.5) / 4.5 * 100);

        thresholdMultiplierSlider.setProgress(thresholdProgress);
        mergeDistanceSlider.setProgress(mergeProgress);

        thresholdMultiplierValue.setText(String.format("%.1f", thresholdMultiplier));
        mergeDistanceValue.setText(String.format("%.1f", mergeDistance));
    }

    private void setupButtons() {
        // é—œé–‰æŒ‰éˆ•
        debugCloseButton.setOnClickListener(v -> {
            Log.d(TAG, "ğŸ”§ DEBUG: é—œé–‰è¦–è¦ºåŒ–é é¢");
            finish();
        });

        // é‡æ–°åˆ†ææŒ‰éˆ•
        debugRefreshButton.setOnClickListener(v -> {
            Log.d(TAG, "ğŸ”§ DEBUG: æ‰‹å‹•é‡æ–°åˆ†ææ•¸æ“š");
            reanalyzeWithCurrentParams();
        });

        // åŒ¯å‡ºæŒ‰éˆ•
        debugExportButton.setOnClickListener(v -> {
            Log.d(TAG, "ğŸ”§ DEBUG: åŒ¯å‡ºæ•¸æ“š");
            exportAnalysisData();
        });
    }

    private void setupChart() {
        // åŸºæœ¬è¨­ç½®
        debugPeakChart.getDescription().setEnabled(false);
        debugPeakChart.setTouchEnabled(true);
        debugPeakChart.setDragEnabled(true);
        debugPeakChart.setScaleEnabled(true);
        debugPeakChart.setPinchZoom(true);

        // Xè»¸è¨­ç½®
        XAxis xAxis = debugPeakChart.getXAxis();
        xAxis.setPosition(XAxis.XAxisPosition.BOTTOM);
        xAxis.setGranularity(1f);
        xAxis.setTextColor(Color.GRAY);

        // Yè»¸è¨­ç½®
        YAxis leftAxis = debugPeakChart.getAxisLeft();
        leftAxis.setGranularity(1f);
        leftAxis.setTextColor(Color.GRAY);

        YAxis rightAxis = debugPeakChart.getAxisRight();
        rightAxis.setEnabled(false);

        Log.d(TAG, "ğŸ”§ DEBUG: åœ–è¡¨è¨­ç½®å®Œæˆ");
    }

    private void loadOriginalData() {
        if (csvFileName == null || csvFileName.isEmpty()) {
            showError("CSV æª”æ¡ˆåç¨±ç‚ºç©º");
            return;
        }

        debugInfoText.setText("ğŸ”„ æ­£åœ¨è¼‰å…¥åŸå§‹æ•¸æ“š...");

        new Thread(() -> {
            try {
                // ğŸ”¥ è®€å–åŸå§‹æ•¸æ“š
                CSVPeakAnalyzer.DEBUGEnhancedAnalysisResult result =
                        CSVPeakAnalyzer.DEBUGPeakAnalyzeWithDetailedInfo(this, csvFileName);

                if (result.success) {
                    // ä¿å­˜åŸå§‹æ•¸æ“š
                    allDataValues = new ArrayList<>(result.allDataValues);
                    allTimePoints = new ArrayList<>(result.allTimePoints);
                    allPhases = new ArrayList<>(result.allPhases);
                    targetColumn = result.targetColumn;
                    averageValue = result.averageValue;

                    // è¨ˆç®—æ¨™æº–å·®
                    calculateStandardDeviation();

                    Log.d(TAG, "ğŸ”§ DEBUG: åŸå§‹æ•¸æ“šè¼‰å…¥æˆåŠŸï¼Œæ•¸æ“šé»: " + allDataValues.size());

                    runOnUiThread(() -> {
                        updateSliderValues();
                        updateSensitivityUI(); // ğŸ›ï¸ æ–°å¢
                        reanalyzeWithCurrentParams();
                    });
                } else {
                    Log.e(TAG, "ğŸ”§ DEBUG: è¼‰å…¥å¤±æ•— - " + result.errorMessage);
                    runOnUiThread(() -> showError("è¼‰å…¥å¤±æ•—: " + result.errorMessage));
                }

            } catch (Exception e) {
                Log.e(TAG, "ğŸ”§ DEBUG: è¼‰å…¥åŸå§‹æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤", e);
                runOnUiThread(() -> showError("è¼‰å…¥éŒ¯èª¤: " + e.getMessage()));
            }
        }).start();
    }

    private void calculateStandardDeviation() {
        double variance = allDataValues.stream()
                .mapToDouble(v -> Math.pow(v - averageValue, 2))
                .average().orElse(0.0);
        standardDeviation = Math.sqrt(variance);
    }

    private void reanalyzeWithCurrentParams() {
        if (allDataValues.isEmpty()) {
            showError("æ²’æœ‰åŸå§‹æ•¸æ“š");
            return;
        }

        debugInfoText.setText("ğŸ”„ æ­£åœ¨é‡æ–°åˆ†æ (åƒæ•¸å·²æ›´æ–°)...");

        new Thread(() -> {
            try {
                // ğŸ›ï¸ ä½¿ç”¨ç•¶å‰åƒæ•¸é‡æ–°åˆ†æå³°å€¼
                double currentThreshold = averageValue + thresholdMultiplier * standardDeviation;

                // æª¢æ¸¬åŸå§‹å³°å€¼
                List<PeakPoint> originalPeaks = detectOriginalPeaks(currentThreshold);

                // é‡åˆ†å¸ƒå³°å€¼
                List<PeakPoint> redistributedPeaks = redistributePeaks(originalPeaks, mergeDistance);

                Log.d(TAG, String.format("ğŸ›ï¸ é‡æ–°åˆ†æå®Œæˆ - é–¾å€¼: %.3f, åŸå§‹å³°å€¼: %d, é‡åˆ†å¸ƒå³°å€¼: %d",
                        currentThreshold, originalPeaks.size(), redistributedPeaks.size()));

                runOnUiThread(() -> {
                    updateInfoDisplay(currentThreshold, originalPeaks, redistributedPeaks);
                    updateChart(originalPeaks, redistributedPeaks);
                });

            } catch (Exception e) {
                Log.e(TAG, "ğŸ”§ DEBUG: é‡æ–°åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤", e);
                runOnUiThread(() -> showError("é‡æ–°åˆ†æéŒ¯èª¤: " + e.getMessage()));
            }
        }).start();
    }

    private List<PeakPoint> detectOriginalPeaks(double threshold) {
        List<PeakPoint> peaks = new ArrayList<>();

        for (int i = 1; i < allDataValues.size() - 1; i++) {
            double prev = allDataValues.get(i - 1);
            double current = allDataValues.get(i);
            double next = allDataValues.get(i + 1);

            // æª¢æŸ¥æ˜¯å¦ç‚ºå±€éƒ¨æœ€å¤§å€¼ä¸”è¶…éé–¾å€¼
            if (current > prev && current > next && current > threshold) {
                PeakPoint peak = new PeakPoint(
                        allTimePoints.get(i),
                        current,
                        allPhases.get(i),
                        i
                );
                peaks.add(peak);
            }
        }

        return peaks;
    }

    private List<PeakPoint> redistributePeaks(List<PeakPoint> originalPeaks, double mergeDistance) {
        List<PeakPoint> result = new ArrayList<>();
        List<PeakPoint> remaining = new ArrayList<>(originalPeaks);

        while (!remaining.isEmpty()) {
            PeakPoint currentPeak = remaining.remove(0);
            List<PeakPoint> closePeaks = new ArrayList<>();
            closePeaks.add(currentPeak);

            // æ‰¾å‡ºæ™‚é–“ç›¸è¿‘çš„å³°å€¼
            remaining.removeIf(peak -> {
                if (Math.abs(peak.time - currentPeak.time) <= mergeDistance) {
                    closePeaks.add(peak);
                    return true;
                }
                return false;
            });

            // é¸æ“‡æ•¸å€¼æœ€é«˜çš„ä½œç‚ºä»£è¡¨
            PeakPoint representativePeak = closePeaks.stream()
                    .max((p1, p2) -> Double.compare(p1.value, p2.value))
                    .orElse(currentPeak);

            result.add(representativePeak);
        }

        return result;
    }

    private void updateInfoDisplay(double threshold, List<PeakPoint> originalPeaks, List<PeakPoint> redistributedPeaks) {
        StringBuilder info = new StringBuilder();
        info.append(String.format("ğŸ“ æª”æ¡ˆ: %s\n", csvFileName));
        info.append(String.format("ğŸ·ï¸ è¨“ç·´: %s\n", trainingLabel));
        info.append(String.format("ğŸ“Š æ•¸æ“šé»: %d å€‹\n", allDataValues.size()));
        info.append(String.format("ğŸ“ˆ å¹³å‡å€¼: %.3f\n", averageValue));
        info.append(String.format("ğŸ“Š æ¨™æº–å·®: %.3f\n", standardDeviation));
        info.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

        // ğŸ›ï¸ é¡¯ç¤ºç•¶å‰æ•æ„Ÿåº¦è¨­å®š
        String[] levelNames = {"æ¥µä½", "ä½", "ä¸­", "é«˜", "æ¥µé«˜"};
        info.append(String.format("ğŸ›ï¸ æ•æ„Ÿåº¦: %s (ç­‰ç´š %d)\n", levelNames[currentSensitivityLevel], currentSensitivityLevel));

        info.append(String.format("ğŸ›ï¸ é–¾å€¼ä¿‚æ•¸: %.1f å€æ¨™æº–å·®\n", thresholdMultiplier));
        info.append(String.format("ğŸ¯ è¨ˆç®—é–¾å€¼: %.3f\n", threshold));
        info.append(String.format("ğŸ”„ åˆä½µè·é›¢: %.1f ç§’\n", mergeDistance));
        info.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
        info.append(String.format("ğŸ” åŸå§‹å³°å€¼: %d å€‹\n", originalPeaks.size()));
        info.append(String.format("ğŸ¯ é‡åˆ†å¸ƒå³°å€¼: %d å€‹\n", redistributedPeaks.size()));

        // çµ±è¨ˆå„éšæ®µå³°å€¼
        long calibratingPeaks = redistributedPeaks.stream().filter(p -> "CALIBRATING".equals(p.phase)).count();
        long maintainingPeaks = redistributedPeaks.stream().filter(p -> "MAINTAINING".equals(p.phase)).count();

        info.append(String.format("ğŸŸ¡ æ ¡æ­£éšæ®µ: %d å€‹\n", calibratingPeaks));
        info.append(String.format("ğŸŸ¢ ç¶­æŒéšæ®µ: %d å€‹\n", maintainingPeaks));

        debugInfoText.setText(info.toString());
    }

    private void updateChart(List<PeakPoint> originalPeaks, List<PeakPoint> redistributedPeaks) {
        // æº–å‚™æ•¸æ“šé›†
        List<Entry> dataEntries = new ArrayList<>();
        List<Entry> originalPeakEntries = new ArrayList<>();
        List<Entry> redistributedPeakEntries = new ArrayList<>();

        // åŸå§‹æ•¸æ“š
        for (int i = 0; i < allDataValues.size(); i++) {
            dataEntries.add(new Entry(allTimePoints.get(i).floatValue(), allDataValues.get(i).floatValue()));
        }

        // å³°å€¼é»
        for (PeakPoint peak : originalPeaks) {
            originalPeakEntries.add(new Entry((float)peak.time, (float)peak.value));
        }
        for (PeakPoint peak : redistributedPeaks) {
            redistributedPeakEntries.add(new Entry((float)peak.time, (float)peak.value));
        }

        // å‰µå»ºæ•¸æ“šé›†
        LineDataSet dataSet = new LineDataSet(dataEntries, "åŸå§‹æ•¸æ“š");
        dataSet.setColor(Color.BLUE);
        dataSet.setLineWidth(1.5f);
        dataSet.setDrawCircles(false);
        dataSet.setDrawValues(false);

        LineDataSet originalPeakSet = new LineDataSet(originalPeakEntries, "åŸå§‹å³°å€¼");
        originalPeakSet.setColor(Color.TRANSPARENT);
        originalPeakSet.setCircleColor(Color.rgb(255, 165, 0));
        originalPeakSet.setCircleRadius(6f);
        originalPeakSet.setDrawCircles(true);
        originalPeakSet.setDrawValues(true);
        originalPeakSet.setValueTextColor(Color.rgb(255, 165, 0));
        originalPeakSet.setValueTextSize(8f);

        LineDataSet redistributedPeakSet = new LineDataSet(redistributedPeakEntries, "é‡åˆ†å¸ƒå³°å€¼");
        redistributedPeakSet.setColor(Color.TRANSPARENT);
        redistributedPeakSet.setCircleColor(Color.RED);
        redistributedPeakSet.setCircleRadius(8f);
        redistributedPeakSet.setDrawCircles(true);
        redistributedPeakSet.setDrawValues(true);
        redistributedPeakSet.setValueTextColor(Color.RED);
        redistributedPeakSet.setValueTextSize(10f);

        // çµ„åˆæ•¸æ“š
        LineData lineData = new LineData();
        lineData.addDataSet(dataSet);
        if (!originalPeakEntries.isEmpty()) {
            lineData.addDataSet(originalPeakSet);
        }
        if (!redistributedPeakEntries.isEmpty()) {
            lineData.addDataSet(redistributedPeakSet);
        }

        // æ›´æ–°åœ–è¡¨
        debugPeakChart.setData(lineData);
        debugPeakChart.invalidate();

        Toast.makeText(this, "ğŸ“ˆ åœ–è¡¨å·²æ›´æ–°ï¼", Toast.LENGTH_SHORT).show();
    }

    private void exportAnalysisData() {
        StringBuilder exportData = new StringBuilder();
        exportData.append("=== DEBUG å³°å€¼åˆ†æå ±å‘Š (ç•¶å‰åƒæ•¸) ===\n");

        // ğŸ›ï¸ åŒ…å«æ•æ„Ÿåº¦è³‡è¨Š
        String[] levelNames = {"æ¥µä½", "ä½", "ä¸­", "é«˜", "æ¥µé«˜"};
        exportData.append(String.format("æ•æ„Ÿåº¦ç­‰ç´š: %s (%d)\n", levelNames[currentSensitivityLevel], currentSensitivityLevel));

        exportData.append(String.format("é–¾å€¼ä¿‚æ•¸: %.1f å€æ¨™æº–å·®\n", thresholdMultiplier));
        exportData.append(String.format("åˆä½µè·é›¢: %.1f ç§’\n", mergeDistance));
        exportData.append("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
        exportData.append(debugInfoText.getText());

        Log.d(TAG, "ğŸ”§ DEBUG: åŒ¯å‡ºæ•¸æ“š:\n" + exportData.toString());
        Toast.makeText(this, "ğŸ“¤ è©³ç´°æ•¸æ“šå·²è¼¸å‡ºåˆ° Logcat", Toast.LENGTH_LONG).show();
    }

    private void showError(String message) {
        debugInfoText.setText("âŒ éŒ¯èª¤: " + message);
        Toast.makeText(this, message, Toast.LENGTH_LONG).show();
        Log.e(TAG, "ğŸ”§ DEBUG: " + message);
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        Log.d(TAG, "ğŸ”§ DEBUG: å³°å€¼è¦–è¦ºåŒ–é é¢éŠ·æ¯€");
    }

    // ğŸ¯ ç°¡åŒ–çš„å³°å€¼é»é¡åˆ¥
    private static class PeakPoint {
        public double time;
        public double value;
        public String phase;
        public int originalIndex;

        public PeakPoint(double time, double value, String phase, int originalIndex) {
            this.time = time;
            this.value = value;
            this.phase = phase;
            this.originalIndex = originalIndex;
        }
    }
}